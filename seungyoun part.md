# 4. Establishing an eVTOL Tiltrotor Flight Simulation Environment

## Section 1. Electric Propulsion Model (KFDS)
$\quad$ The target aircraft is an eVTOL Tiltrotor aircraft that uses an electric propulsion system. Through flight simulation, an electric propulsion model was added to JSBSim, an open source based flight dynamics software, to predict the flight state of the aircraft. The electric propulsion system of the target aircraft consists of a battery, a power distribution board (PDB), an electronic speed controller (ESC), a blushless direct current (BLDC) motor, and a propeller. The power distribution board does not require any special modeling because it serves to distribute the power required by each component. Therefore, the 
remaining components except the power distribution board were modeled. The figure below is the architecture of the electric propulsion model.

<center>

  ![< Picture 24 > KFDS Architecture](final%20image/image24.png)
  
  < Picture 24 > KFDS Architecture

</center>

<br>
<p align="center">35

--------------------------------------------------------------------------
### 1. Battery Model
$\quad$ Batteries store electrical energy and provide electricity to the aircraft during flight. The type and capacity of the battery greatly affects the flight time and performance of the aircraft, and the target aircraft uses a lithium polymer (Li-Po) battery. Lithium polymer batteries are lightweight and have high energy density. They are widely used in various electronic devices and mobile devices, and are also widely used in unmanned aerial vehicles. These lithium polymer batteries can store high energy per unit weight at high energy density and can store energy for a long period of time at a low discharge rate. In addition, since it can handle high discharge current, it can cope with sudden power changes during flight, maintain high voltage, and have relatively light weight. The lithium polymer battery model tables the voltage performance that varies depending on the amount of charge, and models the capacity used to drive other components. The equation below is a voltage model provided by the battery as ESC.

<center>

$U_{Battery_{out}} = U_{Battery} - I_{Battery} \cdot R_{Battery}$

</center>

### 2. ESC Model
$\quad$ The ESC electronically controls the speed of the BLDC motor and transmits the power of the motor. It controls the thrust and torque generated by precisely controlling the rotational speed of the motor and supports the efficient operation of the motor. In addition to controlling the rotational speed of the motor through ESC, it also functions to protect the motor from overheating, overcurrent, short circuit, etc., monitors the voltage of the battery, and protects the battery from discharging. The ESC operates through the reception of the PWM signal, controls the voltage applied to the motor in the internal circuit in accordance with the PWM signal, and controls the rotation of the motor. ESC, used together with BLDC motors, is widely used in unmanned aerial vehicles. The equation below is a voltage model provided by ESC to BLDC motor.

<center>

$U_{ESC} = \delta_{throttle} \cdot R_{Battery} - I_{ESC} \cdot R_{ESC}$

</center>

<br>
<p align="center">36

--------------------------------------------------------------------------
### 3. BLDC Motor Model
$\quad$ The BLDC motor generates rotational motion and rotates the propeller to generate thrust and torque. Since there is no brush, it has the characteristic of operating efficiently without friction and energy loss of the brush, and each motor provides performance in specific flight conditions. It provides excellent performance in high speed and high power applications, and can achieve a higher number of rotations than a brush motor. In addition, there is no external physical contact due to rotation using a magnetic force, and accurate control is possible through an electronic control device. This feature is used in various fields such as unmanned aerial vehicles, electric bicycles, robots, and industrial automation. The equation below is the torque generated by the BLDC motor, the power provided by the propeller, and the current model required by the ESC.

<center>

$Q_{Motor}$ = $K_{t} \cdot (I_{Motor_{required}} - I_{Motor_{idle}}$)

$P_{Motor}$ = $Q_{Motor} \cdot \Omega_{propeller}$

$I_{Motor_{required}} = \frac {U_{ESC} - RPM/ K_{v}} {R_{Motor}}$

</center>

<br>
<p align="center">37

--------------------------------------------------------------------------
### 4. Propeller Model
$\quad$ The propeller generates the thrust and torque of the aircraft through the aerodynamic force in the propeller by the rotational motion generated by the BLDC motor. The performance varies depending on the length, the shape of the propeller cross-section airfoil, the twist, and the pitch angle. The moment of inertia, diameter, the number of blades, and the geometric pitch angle of the propeller were considered, and in order to consider the performance of the propeller that changes according to the forward speed of the aircraft, it was modeled as the thrust and power coefficient according to the forward ratio. The equation below is a model for thrust, power, forward ratio, propeller efficiency, and rotation speed.

<center>

$T$ = $C_{thrust} \rho n^2 D_{prop}^4$

$P$ = $C_{power} \rho n^3 D_{prop}^5$

$J$ = $\frac {V_{inflow}}{nD}$

$\eta$ = $\frac {C_{thrust}V_{inflow}}{C_{power}nD}$

$RPM=RPS + \frac {60(P_{Motor}-P_{required})}{2I_{{xx}_{prop}} \cdot \Omega_{propeller}} \cdot \pi$

</center>

<br>
<p align="center">38

--------------------------------------------------------------------------
## Section 2. Model Database
$\quad$ A database used in aircraft models is needed to predict the condition of the aircraft. The database can express the forces and moments acting on the aircraft. The model database of aircraft is largely divided into shape, weight and balance, aerodynamic, and propulsion.

### 1. Shape Database
$\quad$ The aircraft shape database contains shape information such as the main blade area, length, cord length, and the origin of the wind coordinate system. The origin of the wind coordinate system is defined as AeroRP, and if the aerodynamic force is the position acting on the model and does not exactly match the center of gravity, an additional moment or torsional force is generated. Other aircraft models are not affected, but there are tail control planes and position information due to various needs. The tail control plane information is used by the JSBSim Turbulence code and does not affect the actual flight dynamics model. EYEPOINT is the point at which the pilot's point-in-time position is calculated, and the gravitational acceleration felt by the pilot during flight is calculated. VRP is the origin of the world position in an aircraft. The following is the aircraft shape database information.
</center>

<br>
<p align="center">39

--------------------------------------------------------------------------
<center>

  ![< Graph 5 > Shape Database](final%20image/graph5.png)
  
  < Chart 5 > Shape Database

</center>

<br>
<p align="center">40

--------------------------------------------------------------------------
### 2. Weight and Inertia Database
$\quad$ The weight and inertia database contains information on the physical properties caused by aircraft mass. The moment of inertia creates a slower rotational force than the low value where the high value is not, and the $I_{XZ}$, $I_{YZ}$, and $I_{XY}$ terms are generally zero because the $X$, $Y$, and $Z$ axes are the main axes. However, in the case of an asymmetric aircraft shape, a term may exist because the $X$, $Y$, and $Z$ axes do not match the symmetrical axis of the aircraft. In the case of weight, it represents the empty weight of the aircraft, but in this paper, the weight of each element is considered as 0, and the total weight is represented by generating weight and inertia data for the whole during the analysis process. Therefore, the weight and inertia database shows information for the entire aircraft. The center of gravity represents the origin of the fuselage fixed coordinate system and is the point of action of gravity. The following is information on the weight and inertia database.

<center>

  ![< Graph 6 > Weight and Inertia Database](final%20image/graph6.png)
  
  < Chart 6 > Weight and Inertia Database

</center>

<br>
<p align="center">41

--------------------------------------------------------------------------
### 3. Electric Propulsion System Database
$\quad$ In the case of the propulsion system database, it contains information on the position and performance of the electric propulsion system of the eVTOL drone. The electric propulsion system of the eVTOL drone consists of a battery, an ESC, an electric motor, and a propeller. In the case of position, it represents the position of the electric motor connected to the propeller as the point of action of the thrust. The position database is as follows.

<center>

  ![< Graph 7 > Propulsion System Location Database](final%20image/graph7.png)
  
  < Chart 7 > Propulsion System Location Database

</center>

<br>
<p align="center">42

--------------------------------------------------------------------------
$\quad$ The battery is a PT-B10000-NSR35 product and has a capacity of 10,000 ùëöùê¥‚Ñé, the number of cells is 8, and the discharge rate is 35 ùê∂. The voltage change according to the battery capacity is used in a table format, and the weight is set to 0 because it was considered in the weight and inertia database. As additional data, it has information on the cutoff voltage and the internal resistance of the battery in which the battery does not operate.

<center>

  ![< Graph 8 > Propulsion System Battery Database](final%20image/graph8.png)
  
  < Chart 8 > Propulsion System Battery Database

</center>

<br>
<p align="center">43

--------------------------------------------------------------------------
$\quad$ The ESC uses a FLAME-80A-12S product and, depending on the voltage, generates a PWM signal for driving an electric motor. The weight is set to 0 in consideration of the weight and inertia database, and includes range information of the generated PWM signal. As additional data, it contains information on the maximum minimum voltage, maximum current, and internal resistance.

<center>

  ![< Graph 9 > Propulsion System ESC Database](final%20image/graph9.png)
  
  < Chart 9 > Propulsion System ESC Database

</center>

<br>
<p align="center">44

--------------------------------------------------------------------------
$\quad$ The electric motor is a BLDC (Blushless Direct Current) motor and uses KDE5214XF product. The motor generates and rotates physical torque in response to the PWM signal transmitted from the ESC. The weight is included in the weight and inertia database and is set to 0, and the motor speed constant representing the number of revolutions according to voltage and the motor torque constant representing the torque according to current are included as information on the performance of the motor. Additionally, it contains information on an ideal current and voltage, and maximum current and internal resistance.

<center>

  ![< Graph 10 > Propulsion System Electic Motor Database](final%20image/graph10.png)
  
  < Chart 10 > Propulsion System Electic Motor Database
</center>

<br>
<p align="center">45

--------------------------------------------------------------------------
$\quad$ Torque generated by the electric motor rotates the propeller to generate the thrust and torque acting on the aircraft. The propeller used the XOAR-15x7 product, and a database considering the forward ratio was used as table-type data for the thrust and power coefficients. The propeller database contains the propeller's moment of inertia, diameter, and number of blades, and includes information on the geometric minimum and maximum pitch angle of the blade. The thrust and power coefficients are in the form of a table, according to the minimum rotational speed and the forward ratio representing the performance of the propeller. The independent variables of the two tables are the forward ratio, and the dependent variables are the thrust and power coefficients. In the case of a variable pitch propeller, a two-dimensional table can be used to represent the thrust and power coefficients according to the forward ratio and pitch angle. The following is an equation and database for thrust and power.

<center>

  ![< Graph 11 > Electic Propulsion System Propeller Database](final%20image/graph11.png)
  
  < Graph 11 > Electic Propulsion System Propeller Database
</center>

<br>
<p align="center">46

--------------------------------------------------------------------------
### 3. Aerodynamic Coefficient Database
$\quad$ In the case of the aerodynamic coefficient database, the factors that influence the change of the coefficient were mathematically modeled. Factors that influence the change of the aerodynamic coefficient include the static term, the control term, and the dynamic term. The static term is the aerodynamic coefficient that changes according to the angle of flight and the angle of sliding in the absence of control, that is, the elevation of the control surface. The control term on the basis of the static term is the increment of the aerodynamic coefficient that changes according to the angle of elevation of the control surface, and the dynamic term is the increment of the aerodynamic coefficient that changes according to the angular velocity on the basis of the static term. The following is a mathematical model equation of the aerodynamic coefficient.

<center>

  ![< Graph 12 > Aerodynamic Coefficient Equation](final%20image/graph12.png)
  
  < Graph 12 > Aerodynamic Coefficient Equation
</center>

<br>
<p align="center">47

--------------------------------------------------------------------------
$\quad$ The aerodynamic coefficient static term is an element that changes according to the angle of attack and the angle of sliding. The static term was constructed by using data convergence technology based on CFD and flat plate theory of data ranging from -180 degrees to 180 degrees in flight angle and -180 degrees in slip angle. The following is a 3D graph of the established static term database for each aerodynamic coefficient.

<center>

  ![< Image 25 > Static Term $C_{D}$ Drag Coefficient](final%20image/image25.png)
  
  < Image 25 > Static Term $C_{D}$ Drag Coefficient
  
  ![< Image 26 > Static Term $C_{Y}$ Force Coefficient](final%20image/image26.png)
  
  < Image 26 > Static Term $C_{Y}$ Force Coefficient
</center>

<br>
<p align="center">48

--------------------------------------------------------------------------

<center>

  ![< Image 27 > Static Term $C_{L}$ Lift Coefficient](final%20image/image27.png)
  
  < Image 27 > Static Term $C_{L}$ Lift Coefficient
  
  ![< Image 28 > Static Term $C_{l}$ Rolling Moment Coefficient](final%20image/image28.png)
  
  < Image 28 > Static Term $C_{l}$ Rolling Moment Coefficient
</center>

<br>
<p align="center">49

--------------------------------------------------------------------------

<center>

  ![< Image 29 > Static Term $C_{m}$ Pitching Moment Coefficient](final%20image/image29.png)
  
  < Image 29 > Static Term $C_{m}$ Pitching Moment Coefficient
  
  ![< Image 30 > Static Term $C_{n}$ Yawing Moment Coefficient](final%20image/image30.png)
  
  < Image 30 > Static Term $C_{n}$ Yawing Moment Coefficient
</center>

<br>
<p align="center">50

--------------------------------------------------------------------------
$\quad$ In the case of the aerodynamic coefficient control term by the tail control surface, it is affected by the sliding angle and the lifting angle of the control surface in the transverse direction, and the lifting angle of the control surface in the longitudinal direction. In the case of the aerodynamic coefficient control term by Aileron, it is affected by the sliding angle and the lifting angle of the control surface only in the transverse direction. The following is a graph of the aerodynamic coefficient control term by the tail control surface and Aileron.

<center>
  
  ![< Image 31 > Control Term Left Tail Wing Aerodynamic Factor](final%20image/image31.png)
  
  < Image 31 > Control Term Left Tail Wing Aerodynamic Factor
</center>

<br>
<p align="center">51

--------------------------------------------------------------------------

<center>

  ![< Image 32 > Control Term Right Tail Wing Aerodynamic Factor](final%20image/image32.png)
  
  < Image 32 > Control Term Right Tail Wing Aerodynamic Factor
  
  ![< Image 33 > Control Term Aileron Aerodynamic Factor](final%20image/image33.png)
  
  < Image 33 > Control Term Aileron Aerodynamic Factor
</center>

<br>
<p align="center">52

--------------------------------------------------------------------------
$\quad$ The dynamic term of the aerodynamic coefficient is expressed as a ratio of the amount of change according to the change in angular velocity. In addition, in the longitudinal direction, only the ùëå-axis angular velocity is considered and the cord length is used. In the case of the transverse direction, the ùëã-axis and ùëç-axis angular velocities are considered, and the wing length is used. The following is the database used.

<center>
  
  ![< Graph 13 > Dynamic Drag Coefficient](final%20image/graph13.png)
  
  < Graph 13 > Dynamic Drag Coefficient
</center>

<br>
<p align="center">53

--------------------------------------------------------------------------
## Section 3. Implementation of the Transient Flight Schedule Algorithm
$\quad$ In this paper, the controller structure of the existing PX4-Autopilot is changed to apply the transition flight schedule. The flight command state is transmitted from the state machine module to the autonomous flight module to check and manage the flight command state. The autonomous flight module transmits a position setting value suitable for the multicopter, transition, and fixed-wing flight modes to the position controller according to the received flight command state. Each flight position controller receives a different type of setting value according to the flight command state.
<br>
$\quad$ The multicopter flight position controller receives the positioning values of the ùëã, ùëå, and ùëç axes from the autonomous flight module, and the fixed wing flight position controller receives only the positioning values of the ùëç axis. Since a fixed wing plane cannot fly in place, it only receives the altitude setting value. In the case of the transition flight mode, the existing algorithm does not generate all the positioning values of the ùëã, ùëå, and ùëç axes, and controls the altitude using only the thrust estimator generated. However, it is difficult to expect good performance because this type of transition flight algorithm only controls the altitude with an estimator. Accordingly, only the positioning value of the ùëç axis was set to the altitude at which the transition flight started, so that the controller worked together to maintain the altitude.
<br>
$\quad$ The posture setting value generated by the flight position controller is transmitted to the Tiltrotor posture controller, and the posture setting value is selected according to the flight command state received from the state machine module. In the existing transition flight algorithm, the roll generates a setting value to maintain the horizontal in the transition flight process, and the yaw generates a setting value to maintain the transition flight start direction. In the case of the pitch posture angle, a setting value to maintain the horizontal is generated. On the other hand, in the case of the transition flight schedule algorithm, the flight angle of the aircraft during horizontal flight in the transition flight process can be regarded as the same as the pitch posture angle, so the flight angle schedule of the aircraft was applied as the pitch posture angle setting value of the controller.
<br>
<p align="center">54

--------------------------------------------------------------------------
$\quad$ In order to implement the transition flight schedule algorithm, it was input into the database in advance during the transition flight and delivered over time. In addition, the throttle setting value generated by the flight position controller was used according to the transition flight phase, the throttle setting value generated by the multicopter position controller was used in the first phase, and the throttle setting value generated by the fixed wing position controller was used in the second phase. To this end, the estimator of the fixed wing position controller was activated from the start of the transition flight, and the point of change to the second phase was a specific time derived from the analysis that the rear thrust was no longer required.
<br>
$\quad$ In the case of propeller tilt angle control, the existing transition flight algorithm changes linearly based on time or speed and drives it independently of other controllers. In order to implement the transition flight schedule algorithm, it was changed according to the propeller tilt angle according to the time previously entered into the database during the transition flight. The following is a table and a transition flight schedule control algorithm architecture showing the set values for each flight mode.
<br>
<p align="center">55

--------------------------------------------------------------------------

<center>
  
  ![< Graph 14 > Reference Settings by Flight Mode](final%20image/graph14.png)
  
  < Graph 14 > Reference Settings by Flight Mode
</center>

<br>
<p align="center">56

--------------------------------------------------------------------------

<center>
  
  ![< Image 34 > Transition Flight Schedule Control Algorithm Architecture](final%20image/image34.png)
  
  < Image 34 > Transition Flight Schedule Control Algorithm Architecture
</center>

<br>
<p align="center">57

--------------------------------------------------------------------------
## Section 4. Flight Simulation Integration (SITL ‚Äì Software In The Loop)
$\quad$ The flight simulation established a software-in-the-loop (SITL) simulation environment through integration between the flight control software PX4-Autopilot and the flight dynamics software JSBSim. The SITL simulation interacts through MAVLink communication. The flight control software receives virtual sensor data using aircraft state (position, posture, speed, angular velocity) from the flight dynamics software through MAVLink communication, and after state estimation from the virtual sensor data, it sends a target actuator signal through the controller to the flight dynamics software through MAVLink communication. By repeating this process, a simulation through a loop between different software is performed. The following is the data communication structure between the PX4 flight stack and the simulator for the SITL simulation.

<center>
  
  ![< Image 35 > SITL Data Communication Structure](final%20image/image35.png)
  
  < Image 35 > SITL Data Communication Structure
</center>

<br>
<p align="center">58

--------------------------------------------------------------------------
$\quad$ The SITL simulation was integrated in a Linux operating system environment. KFDS flight dynamics software based on JSBSim is installed as an operating system program, which can be called from any location in the operating system. In addition, the simulation is started through PX4 and for this purpose, the flight dynamics software is retrieved from the PX4 code and used, and data is converted through a bridge responsible for communication between the two.
<br>
$\quad$ The bridge performs a conversion to simulate a virtual sensor based on the aircraft state generated by the flight dynamics software and transmits it to the flight control software's virtual sensor data through MAVLink communication. In addition, the actuator signal generated by the flight control software is JSBSim's FGFCS to deliver to the flight dynamics software
It is converted into a control surface or throttle command value through a class and delivered. Through the bridge, a communication loop was created between two different software to build an SITL simulation environment.
<br>
$\quad$ In addition, QGroundControl and Unreal Engine, which are software for controlling and monitoring airplanes of SITL flight simulation, were integrated. First, QGroundControl, which corresponds to GCS (Ground Control Station), was integrated through MAVLink communication in order to fly airplanes and deliver missions in SITL simulation. QGroundControl, an open source-based ground control software, can perform functions such as mission planning and execution, real-time data display, flight log recording, flight control parameter adjustment, etc. In addition, it was integrated through MAVLink communication to utilize the virtual environment of Unreal Engine as software for visualization. In addition, for future research expansion to the UAM operation digital twin, integration using MAVLink communication with UAM stakeholder software, PSU, Fleet Operator, Vertiport Operator, and AI Autonomous System was performed. The following is the SITL architecture consisting of PX4-Autopilot and KFDS, and the overall flight simulation architecture additionally configured.
</center>

<br>
<p align="center">59

--------------------------------------------------------------------------

<center>
  
  ![< Image 36 > PX4-KFDS SITL Architecture](final%20image/image36.png)
  
  < Image 36 > PX4-KFDS SITL Architecture
</center>

<br>
<p align="center">60

--------------------------------------------------------------------------

<center>
  
  ![< Image 37 > Full Flight Simulation Architecture](final%20image/image37.png)
  
  < Image 37 > Full Flight Simulation Architecture
</center>

<br>
<p align="center">61

--------------------------------------------------------------------------